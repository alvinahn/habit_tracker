<style>
  .week span {
    display: inline-block;
    width: 70px;

    /* NoSelect */
    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none;   /* Chrome/Safari/Opera */
    -khtml-user-select: none;    /* Konqueror */
    -moz-user-select: none;      /* Firefox */
    -ms-user-select: none;       /* IE/Edge */
    user-select: none;           /* non-prefixed version, currently
                                    not supported by any browser */
  }

  .week span {
    cursor: pointer;
  }

  .toggle-today {
    color:yellow;
    font-weight: bold;
  }

  .toggle-day-red {
    background-color:red;
  }
  .toggle-day-red.red {
    background-color:red;
  }
  .toggle-day-red.green {
    background-color:green;
  }

  .toggle-day-green {
    background-color:green;
  }
  .toggle-day-green.red {
    background-color:red;
  }
  .toggle-day-green.green {
    background-color:green;
  }

  .toggle-day-gray {
    background-color:gray;
  }
</style>
<script src="/javascript/pie-chart.js" type="text/javascript"></script>
<script type="text/javascript">

    $(document).ready(function () {
      //draws circle and %
        $('#demo-pie-1').pieChart({ //draws circle even with empty function
            barColor: '#3bb2d0',
            trackColor: '#eee',
            lineCap: 'round',
            lineWidth: 8,
            onStep: function (from, to, percent) {    //draws %
                $(this.element).find('.pie-value').text(Math.round(percent) + '%');
            }
        });

        $('#demo-pie-2').pieChart({
            barColor: '#fbb03b',
            trackColor: '#eee',
            lineCap: 'butt',
            lineWidth: 8,
            onStep: function (from, to, percent) {
                $(this.element).find('.pie-value').text(Math.round(percent) + '%');
            }
        });

        $('#demo-pie-3').pieChart({
            barColor: '#ed6498',
            trackColor: '#eee',
            lineCap: 'square',
            lineWidth: 8,
            onStep: function (from, to, percent) {
                $(this.element).find('.pie-value').text(Math.round(percent) + '%');
            }
        });
 
    });

    function updateSuccessRate(day_id, val) {

      if(day_id <= 7) {
        $id = $("#week1_success_rate");
        $pie_id = $("#demo-pie-1");
      }
      else if(day_id <= 14) {
        $id = $("#week2_success_rate");
        $pie_id = $("#demo-pie-2");
      }
      else if(day_id <= 21) {
        $id = $("#week2_success_rate");
        $pie_id = $("#demo-pie-3");
      }

      if(val == "T") {
        success_rate = (parseFloat($id.html()) + 14.3).toFixed(1);
      }
      else {
        success_rate = (parseFloat($id.html()) - 14.3).toFixed(1);
      }

      if(success_rate < 0) success_rate = 0;
      if(success_rate > 100) success_rate = 100;

      $id.html(success_rate); //works
      //$pie_id.data-percent = success_rate;
      //$pie_id.attr("pie-value",50);

      $('#demo-pie-1').pieChart({ //draws circle even with empty function
          barColor: '#3bb2d0',
          trackColor: '#eee',
          lineCap: 'round',
          lineWidth: 8,
          onStep: function (from, to, percent) {    //draws %
              $(this.element).find('.pie-value').text(Math.round(percent) + '%');
          }
      });

    }

    function updateDay(day_id, val) {
      //str = "/echo/js/?js=<h2>" + val + "</h2>";
      str = "/update_day";
      $.ajax({
        url: str,
        data: {
          habit: <%= @habit.id %>,
          day: day_id,
          result: val
        },
        complete: function(response) {
          //$('#output' + day_id).html(day_id+val);
          updateSuccessRate(day_id, val);
        }
      });
      return false;
    }

    $(document).ready(function(){
      $(".toggle-day-red").on('click', function() {
        id = $(this).attr('id');
        if ($(this).hasClass('green')) {
            $(this).removeClass('green').addClass('red');
            updateDay(id, "F");
        }
        else {
            $(this).removeClass('red').addClass('green');
            updateDay(id, "T");
        }
      });
    });

    $(document).ready(function(){
      $(".toggle-day-green").on('click', function() {
        id = $(this).attr('id');
        if ($(this).hasClass('red')) {
            $(this).removeClass('red').addClass('green');
            updateDay(id, "T");
        }
        else {
            $(this).removeClass('green').addClass('red');
            updateDay(id, "F");
        }
      });
    });

</script>


<!-- testing: -->
<!-- <div id="output1">waiting for action</div>
<div id="output2">waiting for action</div>
<div id="output3">waiting for action</div>
<div id="output4">waiting for action</div>
<div id="output5">waiting for action</div>
<div id="output6">waiting for action</div>
<div id="output7">waiting for action</div> -->
<!-- /testing -->


<h1 class="habit-title"><%= @habit.name %></h1>

<div class="habit-title">

  <div class="habit-week-pie">
    <div>
      <h5>Week 1</h5>
      <label>Success Rate</label>
    </div>
    <div>    
      <div id="demo-pie-1" class="pie-title-center" data-percent="<%= week1_success_rate(@habit.id)%>">
        <span class="pie-value"></span>
      </div>
    </div>
  </div>

  <div class="habit-week-pie2">
    <div>
      <h5>Week 2</h5>
      <label>Success Rate</label>
    </div>
    <div>    
      <div id="demo-pie-2" class="pie-title-center" data-percent="<%= week2_success_rate(@habit.id)%>">
        <span class="pie-value"></span>
      </div>
    </div>
  </div>

  <div class="habit-week-pie">
    <div>
      <h5>Week 3</h5>
      <label>Success Rate</label>
    </div>
    <div>    
      <div id="demo-pie-3" class="pie-title-center" data-percent="<%= week3_success_rate(@habit.id)%>">
        <span class="pie-value"></span>
      </div>
    </div>
  </div>

</div>



  <div class="week">
    <strong><p>Week 1</p></strong>
    <% calendar_today = (Date.today - @habit.start_date + 1).to_i
      output = ""
      @week1.each do |day|
        if day.position == calendar_today
          span_class = "toggle-today"
          if day.result == "T"
            span_class += " toggle-day-green"
          else
            span_class += " toggle-day-green"
          end
        elsif day.position > calendar_today
          span_class = "toggle-day-gray"
        elsif day.result == "T"
          span_class = "toggle-day-green"
        else  # assume day.result is not checked
          span_class = "toggle-day-red"
        end
        output += "<span name=\"#{day.position}\" id=\"#{day.position}\" value=\"#{day.result}\" class=\"#{span_class}\">Day #{day.position}</span>\n"
      end
    %>
    <%= output %>
    <p>Success Rate: <span id="week1_success_rate"><%= week1_success_rate(@habit.id) %></span>%<p>
  </div>

  <div class="week">
    <strong><p>Week 2</p></strong>
    <% calendar_today = (Date.today - @habit.start_date + 1).to_i
      output = ""
      @week2.each do |day|
        if day.position == calendar_today
          span_class = "toggle-today"
        elsif day.position > calendar_today
          span_class = "toggle-day-gray"
        elsif day.result == "T"
          span_class = "toggle-day-green"
        else  # assume day.result is not checked
          span_class = "toggle-day-red"
        end
        output += "<span name=\"#{day.position}\" id=\"#{day.position}\" value=\"#{day.result}\" class=\"#{span_class}\">Day #{day.position}</span>\n"
      end
    %>
    <%= output %>
    <p>Success Rate: <span id="week2_success_rate"><%= week2_success_rate(@habit.id) %></span>%<p>
  </div>

  <div class="week">
    <strong><p>Week 3</p></strong>
    <% calendar_today = (Date.today - @habit.start_date + 1).to_i
      output = ""
      @week3.each do |day|
        if day.position == calendar_today
          span_class = "toggle-today"
        elsif day.position > calendar_today
          span_class = "toggle-day-gray"
        elsif day.result == "T"
          span_class = "toggle-day-green"
        else  # assume day.result is not checked
          span_class = "toggle-day-red"
        end
        output += "<span name=\"#{day.position}\" id=\"#{day.position}\" value=\"#{day.result}\" class=\"#{span_class}\">Day #{day.position}</span>\n"
      end
    %>
    <%= output %>
    <p>Success Rate: <span id="week3_success_rate"><%= week3_success_rate(@habit.id) %></span>%<p>
  </div>


<% date_diff = (Date.today - @habit.start_date).to_i
  if date_diff >= 21
    delete_submit_value = "Delete from record"
  elsif date_diff >= 0
    delete_submit_value = "I give up"
  else
    delete_submit_value = "Forget it"
  end
%>
<form method = "POST" action="/profile/delete">
  <input type="hidden" name="habit_id" value="<%= @habit.id %>">
  <input type="submit" value="<%= delete_submit_value %>">
</form>
<br>
<a href="/profile">Back to profile page</a>